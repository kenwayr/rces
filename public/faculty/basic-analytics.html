<style type="text/css">
#basicAnalyticsContainer, .loader-container
{
	opacity: 0;
	transition: opacity 0.3s linear;
}
#basicAnalyticsContainer.active, .loader-container.active
{
	opacity: 1;
}
.loader-container
{
	position: fixed;
	top: 50%;
	left: 50%;
	transform: translateX(-50%, -50%);
	text-align: center;
}
.loader-container > .loader-progress-text
{
	margin-top: 10px;
}
.loader-container > .loader
{
	margin: 0 auto;
	border: 16px solid #f3f3f3; /* Light grey */
	border-top: 16px solid #3498db; /* Blue */
	border-radius: 50%;
	width: 120px;
	height: 120px;
	animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.legend
{
	display: block;
	width: 100%;
	text-align: center;
}

.legend > .key
{
	display: inline-block;
	margin: 10px auto;
	padding: 10px;
	border: 1px solid #E4E4E4;
	border-radius: 5px;
	background-color: #fff;
}

.legend > .key > .indicator
{
	display: inline-block;
	width: 20px;
	height: 20px;
	border-radius: 20px;
	margin: 5px;
	vertical-align: middle;
}
.legend > .key > .header
{
	vertical-align: middle;
	font-size: 14pt;
}
.legend > .key > .count
{
	display: block;
	font-size: 12pt;
	font-weight: bolder;
}
.basic-overview-box
{
	display: block;
    border: 1px solid #E4E4E4;
    border-radius: 5px;
    padding: 5px 10px 5px 10px;
}
.basic-overview-box > .header
{
	font-size: 12pt;
}

.class-grid
{
    position: relative;
    display: block;
    margin: 0 auto;
    height: auto;
    padding: 5px;
    user-select: none;
}
.class-grid > .grid-cell
{
    display: inline-block;
    width: 30px;
    height: 30px;
    margin: 5px;
    border-radius: 30px;
    text-align: center;
    vertical-align: middle;
    line-height: 2.4em;
    cursor: pointer;
}
.class-grid > .grid-cell > .unoccupied
{
	display: inline-block;
	width: 30px;
	height: 30px;
	background-image: url(../commons/images/seat.png);
    background-size: contain;
    background-repeat: no-repeat;
}
.class-grid > .grid-cell.alert-doubt
{
	animation: animationDoubt 5s ease-out;
}

.class-grid > .grid-cell.alert-not-understood
{
	animation: animationNotUnderstood 5s ease-out;
}

.class-grid > .grid-cell.alert-please-repeat
{
	animation: animationPleaseRepeat 5s ease-out;
}

.btn-warning-light
{
	background-color: #ffda56;
	color: #fff;
}
.btn-danger-light
{
	background-color: #ff5656;
	color: #fff;
}
.btn-primary-light
{
	background-color: #62aafc;
	color: #fff;
}

.grid-cell.alert-doubt
{
	background-color: rgba(255, 237, 107, 0.8);
}
.grid-cell.alert-explain
{
	background-color: rgba(220, 53, 69, 0.8);
}
.grid-cell.alert-repeat
{
	background-color: rgba(147, 192, 255, 0.8);
}
</style>
<div>
    <div class="page-title">
        <div class="title_left">
            <h3>
                Basic Analytics
                <small>
                	Session analytics and data export
                </small>
            </h3>
        </div>
    </div>
    <div class="clearfix"></div>

    <div id="basicAnalyticsContainer" class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Overview <small>Summary of session</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                	<div class="basic-overview-box">
                		<div class="header">
                			<span data-var="courseTitle"></span>
                			(<span data-var="courseCode"></span>)
                		</div>
                		<hr>
                		<div>
                			<span style="font-weight: bolder;">Room Code: </span>
                			<span data-var="roomID"></span>
                		</div>
                		<div>
                			<span style="font-weight: bolder;">Date-Time: </span>
                			<span data-var="sessionDate"></span>
                		</div>
                		<div>
                			<span style="font-weight: bolder;">Duration: </span>
                			<span data-var="sessionDuration"></span>
                		</div>
                	</div>
                	<div class="legend">
						<div class="key">
							<span class="indicator" style="background-color: #ffc107;"></span>
							<span class="header">DOUBT</span>
							<span data-var="doubtCount" class="count">0</span>
						</div>
						<div class="key">
							<span class="indicator" style="background-color: #dc3545;"></span>
							<span class="header">EXPLAIN</span>
							<span data-var="explainCount" class="count">0</span>
						</div>
						<div class="key">
							<span class="indicator" style="background-color: #007bff;"></span>
							<span class="header">REPEAT</span>
							<span data-var="repeatCount" class="count">0</span>
						</div>
						<div class="key">
							<span class="indicator">
								<i class="fas fa-pause"></i>
							</span>
							<span class="header">Total Pause Time</span>
							<span data-var="totalPauseTime" class="count">0</span>
						</div>
					</div>
                </div>
            </div>
        </div>
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Playback <small>Audio recording</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                	<div id="playbackWaveform">
						<div id="playback-wave-timeline"></div>
					</div>

					<button id="playbackTogglePlayWaveRecord" class="btn btn-primary">
						<i class="fas fa-play"></i>
						/
						<i class="fas fa-pause"></i>
					</button>
                </div>
            </div>
        </div>
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Event Overview<small>View specific event activity</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                	<div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-warning-light active">
                            <input type="radio" name="eventType" value="doubt" checked="checked"> Doubt
                        </label>
                        <label class="btn btn-danger-light">
                            <input type="radio" name="eventType" value="explain"> Explain
                        </label>
                        <label class="btn btn-primary-light">
                            <input type="radio" name="eventType" value="repeat"> Repeat
                        </label>
                    </div>
                	<div style="overflow: auto; max-width: 100%;">
						<div style="width: 100%; text-align: center;"><i class="fas fa-chalkboard-teacher fa-3x"></i></div>
						<div id="playbackClassroomLayout" class="class-grid"></div>
					</div>
                </div>
            </div>
        </div>
    </div>

    <div class="loader-container active">
    	<div class="loader"></div>
    	<div data-var="loaderProgressText" class="loader-progress-text">
    		Getting things ready
    	</div>
    </div>

</div>
<script type="text/javascript">
	var playbackWavesurferTimeline;
	function GenerateBasicAnalytics(resource_id) {
		SetVariable('loaderProgressText', 'Fetching session from server');
		$.ajax({
			url: 'http://localhost:1337/resource',
			type: 'GET',
			data: {id: resource_id},
			success: function (response) {
				setTimeout(function () {
					SetVariable('loaderProgressText', 'Parsing raw session data');
					var data = JSON.parse(response);
					var rawSessionData = JSON.parse(data.binaryData);
					var sessionData = new SessionData();
					sessionData.ConstructFromJSON(rawSessionData, function (data) {
						SetVariable('loaderProgressText', 'Generating session views');

						SetVariable('courseTitle', data.course.title);
						SetVariable('courseCode', data.course.code);
						SetVariable('roomID', data.room.id);
						SetVariable('sessionDate', new Date(data.dateTime.UTCTimestampMillis));
						SetVariable('sessionDuration',
							(data.duration.Hours > 0 ? data.duration.Hours + ' hrs ' : '') + 
							(data.duration.Minutes > 0 ? data.duration.Minutes + ' mins ' : '') + 
							(data.duration.Seconds > 0 ? data.duration.Seconds + ' secs' : '')
						);
						var overview = data.studentEventLogs.reduce(
							(a,v,i) => {
								if(v.type === "doubt")
									a.doubtCount += 1;
								else if(v.type === "explain")
									a.explainCount += 1;
								else if(v.type === "repeat")
									a.repeatCount += 1;
								return a;
							},
							{
								doubtCount: 0,
								explainCount: 0,
								repeatCount: 0
							}
						);
						SetVariable('doubtCount', overview.doubtCount);
						SetVariable('explainCount', overview.explainCount);
						SetVariable('repeatCount', overview.repeatCount);
						SetVariable('totalPauseTime', new Date(data.pauseTime.value).format('u:q:z'));

						var regions = ComputePlaybackRegions(data.duration.StartUTCTimestamp, data.studentEventLogs);

						playbackWavesurferTimeline = WaveSurfer.create({
							container: document.querySelector('#playbackWaveform'),
					        waveColor: '#A8DBA8',
					        progressColor: '#3B8686',
							plugins: [
							    WaveSurfer.regions.create({
							        container: '#wave-timeline',
							        regions: regions
							    })
							]
						});
						playbackWavesurferTimeline.loadBlob(data.mediaRecBlob);

						$("#playbackTogglePlayWaveRecord").click(function () {
					    	playbackWavesurferTimeline.playPause();
					    });

					    MakeGrid('#playbackClassroomLayout', data.room.seat_matrix);
					    FillGrid('#playbackClassroomLayout', 'doubt', data.studentEventLogs);

					    $("input[name='eventType']").on("change", function () {
					    	FillGrid('#playbackClassroomLayout', $("input[name='eventType']:checked")[0].value, data.studentEventLogs);
					    });

						SetVariable('loaderProgressText', 'Done.');
						$("#basicAnalyticsContainer").addClass('active');
						$(".loader-container").removeClass('active');
					});
				}, 0);
			}
		});
	}

	function ComputePlaybackRegions(sessionStartTime, eventLogs) {
		var colorCodes  = {
			doubt: 'hsla(58, 89%, 61%, 0.8)',
			repeat: 'hsla(200, 50%, 70%, 0.4)',
			explain: 'hsla(2, 89%, 61%, 0.8)',
			default: 'hsla(0, 0%, 90%, 0.9)'
		};

		var allowedTimeFrameInSecs = 5;

		var regions = [];
		for(var i=0; i < eventLogs.length; i++) {
			var time = (eventLogs[i].timestamp - sessionStartTime) / 1000; //divided time diff by 1000 to convert to seconds
			var approx = regions.findIndex((v) => { return Math.abs(v.start - time) < allowedTimeFrameInSecs; });
			if(approx !== -1)
			{
				// add some countings later
			}
			else
			{
				regions.push({
					start: parseInt(time),
					end: parseInt(time + allowedTimeFrameInSecs),
					color: colorCodes[eventLogs[i].type] || colorCodes.default
				});
			}
		}
		return regions;
	}
	function MakeGrid(elm, stateMatrix) {
	    var list = '';
	    stateMatrix = stateMatrix.filter((v) => {
	    	if(v.filter((x) => {
	    		return x > 0;
	    	}).length === 0)
	    		return false;
	    	return true;
	    });
	    var prevState = stateMatrix;
	    var m = stateMatrix.length, n = stateMatrix[0].length;
	    for(var i=0; i < m; i++) {
	        for(var j=0; j < n; j++) {
	            list += '<div data-row="' + i + '" data-col="' + j + '" data-selected="' + (prevState === null ? 0 : prevState[i][j]) + '" class="grid-cell">' +
	            	(prevState[i][j] == 1 ?'<i class="unoccupied"></i>': '') +
	            	'</div>';
	        }
	    }
	    $(elm).html(list);
	    var cellWidth = parseFloat($(".grid-cell").css('width'));
	    var cellMargin = parseFloat($(".grid-cell").css('margin'));
	    var computedWidth = (cellWidth + cellMargin*2 )*n;
	    $(elm).width(computedWidth);
	    $(".grid-cell").on('click', function(e) {
	        $(this).trigger('action');
	    });
	}
	function FillGrid(elm, type, logs) {
		$(elm + " > .grid-cell").removeClass("alert-doubt alert-explain alert-repeat");
		for(var i=0; i < logs.length; i++) {
			if(logs[i].type === type) {
				var e = $(elm + " > .grid-cell[data-row='" + logs[i].seat.row + "'][data-col='" + logs[i].seat.col + "']");
				e.html('<i class="fas fa-mobile-alt fa-fw fa-lg"></i>');
				e.addClass('alert-' + type);
			}
		}
	}
</script>